{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Specifies the location for all resources."
            }
        },
        "mlClusterName": {
            "type": "string",
            "metadata": {
                "description": "Specifies the name of the Azure Machine Learning compute cluster."
            }
        },
        "mlWorkspaceId": {
            "type": "string",
            "metadata": {
                "description": "Specifies the resource ID of the Azure Machine Learning workspace."
            }
        },
        "mlClusterMaxNodeCount": {
            "type": "int",
            "minValue": 0,
            "metadata": {
                "description": "Specifies the maximum node count of the Azure Machine Learning compute cluster."
            }
        },
        "mlClusterVmPriority": {
            "type": "string",
            "allowedValues": [
                "Dedicated",
                "LowPrority"
            ],
            "metadata": {
                "description": "Specifies the priority of the Azure Machine Learning compute cluster."
            }
        },
        "mlClusterVmSize": {
            "type": "string",
            "allowedValues": [
                "Standard_D1_v2",
                "Standard_D2_v2",
                "Standard_D3_v2",
                "Standard_D4_v2",
                "Standard_D11_v2",
                "Standard_D12_v2",
                "Standard_D13_v2",
                "Standard_D14_v2",
                "Standard_DS1_v2",
                "Standard_DS2_v2",
                "Standard_DS3_v2",
                "Standard_DS4_v2",
                "Standard_DS5_v2",
                "Standard_DS11_v2",
                "Standard_DS12_v2",
                "Standard_DS13_v2",
                "Standard_DS14_v2",
                "Standard_M8-2ms",
                "Standard_M8-4ms",
                "Standard_M8ms",
                "Standard_M16-4ms",
                "Standard_M16-8ms",
                "Standard_M16ms",
                "Standard_M32-8ms",
                "Standard_M32-16ms",
                "Standard_M32ls",
                "Standard_M32ms",
                "Standard_M32ts",
                "Standard_M64-16ms",
                "Standard_M64-32ms",
                "Standard_M64ls",
                "Standard_M64ms",
                "Standard_M64s",
                "Standard_M128-32ms",
                "Standard_M128-64ms",
                "Standard_M128ms",
                "Standard_M128s",
                "Standard_M64",
                "Standard_M64m",
                "Standard_M128",
                "Standard_M128m",
                "Standard_D1",
                "Standard_D2",
                "Standard_D3",
                "Standard_D4",
                "Standard_D11",
                "Standard_D12",
                "Standard_D13",
                "Standard_D14",
                "Standard_DS15_v2",
                "Standard_NV6",
                "Standard_NV12",
                "Standard_NV24",
                "Standard_F2s_v2",
                "Standard_F4s_v2",
                "Standard_F8s_v2",
                "Standard_F16s_v2",
                "Standard_F32s_v2",
                "Standard_F64s_v2",
                "Standard_F72s_v2",
                "Standard_NC6s_v3",
                "Standard_NC12s_v3",
                "Standard_NC24rs_v3",
                "Standard_NC24s_v3",
                "Standard_NC6",
                "Standard_NC12",
                "Standard_NC24",
                "Standard_NC24r",
                "Standard_ND6s",
                "Standard_ND12s",
                "Standard_ND24rs",
                "Standard_ND24s",
                "Standard_NC6s_v2",
                "Standard_NC12s_v2",
                "Standard_NC24rs_v2",
                "Standard_NC24s_v2",
                "Standard_ND40rs_v2",
                "Standard_NV12s_v3",
                "Standard_NV24s_v3",
                "Standard_NV48s_v3"
            ],
            "metadata": {
                "description": "Specifies the SKU of the Azure Machine Learning compute cluster."
            }
        },
        "subnetId": {
            "type": "string",
            "metadata": {
                "description": "Specifies the resource id of the subnet which the cluster uses."
            }
        }
    },
    "functions": [],
    "variables": {
        "location": "[parameters('location')]",
        "mlClusterName": "[parameters('mlClusterName')]",
        "mlWorkspaceId": "[parameters('mlWorkspaceId')]",
        "mlWorkspaceName": "[last(split(variables('mlWorkspaceId'), '/'))]",
        "mlClusterMaxNodeCount": "[parameters('mlClusterMaxNodeCount')]",
        "mlClusterVmPriority": "[parameters('mlClusterVmPriority')]",
        "mlClusterVmSize": "[parameters('mlClusterVmSize')]",
        "subnetId": "[parameters('subnetId')]"

    },
    "resources": [
        {
            "type": "Microsoft.MachineLearningServices/workspaces/computes",
            "apiVersion": "2020-09-01-preview",
            "name": "[concat(variables('mlWorkspaceName'), '/', variables('mlClusterName'))]",
            "location": "[variables('location')]",
            "identity": {
                "type": "SystemAssigned"
            },
            "sku": {
                "name": "Basic",
                "tier": "Basic"
            },
            "properties": {
                "computeLocation": "[variables('location')]",
                "computeType": "AmlCompute",
                "description": "[variables('mlClusterName')]",
                "properties": {
                    "remoteLoginPortPublicAccess": "Disabled",
                    "scaleSettings": {
                        "minNodeCount": 0,
                        "maxNodeCount": "[variables('mlClusterMaxNodeCount')]",
                        "nodeIdleTimeBeforeScaleDown": "PT120S"
                    },
                    "subnet": {
                        "id": "[variables('subnetId')]"
                    },
                    "vmPriority": "[variables('mlClusterVmPriority')]",
                    "vmSize": "[variables('mlClusterVmSize')]",
                    "osType": "Linux",
                    // "virtualMachineImage": {
                    //     "id": ""
                    // }
                    "isolatedNetwork": true,
                    "enableNodePublicIp": false
                }
            }
        }
    ],
    "outputs": {}
}